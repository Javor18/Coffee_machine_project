{% load static %}
{% block css_block %}
    <link rel="stylesheet" href="{% static 'cart.css' %}">
    <link rel="stylesheet" href="{% static 'cart-responsive.css' %}">
{% endblock %}
<script src="https://kit.fontawesome.com/4cf7026c74.js" crossorigin="anonymous"></script>

{% block content %}
	<div class="row">
		<div class="col-lg-12">
			<div class="box-element">

				<a  class="btn btn-outline-dark" href="{% url 'main' %}">&#x2190; Continue Shopping</a>

				<br>
				<br>
				<table class="table">
					<tr>
                        <th><h5>Items: <strong>{{ order.get_cart_items }}</strong></h5></th>
						<th><h5>Total:<strong>${{order.get_cart_total|floatformat:2}}</strong></h5></th>
						<th>
                            <button style="float:right; margin:5px;" id="show-img-btn" class="btn btn-success">Pay Now</button>
                            <div id="img-overlay">
                            <img src="{% static 'images/card-payment.png' %}" alt="">
                        </div>

                        <div id="img-overlay-1">
                            <h1>Please collect your order</h1>
                            <img src="{% static 'images/checked.png' %}">
                        </div>

                        <div id="loading-dots">
                            <h1>Loading</h1>
                            <div class="dots">
                            <h1 class="dot one">.</h1><h1 class="dot two">.</h1><h1 class="dot three">.</h1>
                            </div>
                        </div>
						</th>
					</tr>
				</table>

			</div>

			<br>

			<div class="box-element">
				<div class="cart-row">
					<div style="flex:2"></div>
					<div style="flex:2"><strong>Item</strong></div>
					<div style="flex:1"><strong>Price</strong></div>
					<div style="flex:1"><strong>Quantity</strong></div>
					<div style="flex:1"><strong>Total</strong></div>
                    <div style="flex:1"><strong>Delete</strong></div>

				</div>

                {% for item in items %}
				<div class="cart-row">
                    <div style="flex:2"><img class="row-image" src="{% static 'images/'|add:item.product.name|add:'.jpg' %}" alt="Drink Image" /></div>
                    <div style="flex:2"><p>{{item.product.name}}</p></div>
                    <div style="flex:1"><p>${{item.product.price|floatformat:2}}</p></div>
					<div style="flex:1">
{#						<p class="quantity">x{{item.quantity}}</p>#}
                        <p class="quantity">{{item.quantity}}</p>
						<div class="quantity">

                            <div class="chg-quantity">
                                <button id="arrow-up" data-product="{{ item.product.id }}" data-quantity="{{ item.product.quantity }}" data-action="plus"><i class="fa-solid fa-arrow-up"></i></button>
                                <button id="arrow-down" data-item="{{ item.product.id }}" data-quantity="{{ item.product.quantity }}" data-action="remove"><i class="fa-solid fa-arrow-down"></i></button>
                            </div>
						</div>
					</div>
                    <div style="flex:1"><p>${{item.get_total|floatformat:2}}</p></div>
                 <div style="flex:1">
{#                        <button id="trash" data-item="{{ item.product.id }}" data-quantity="{{ item.product.quantity }}" data-action="delete"><i class="fa-solid fa-trash"></i></button>#}
                        <button id="trash" data-item="{{ item.product.id }}" data-quantity="{{ item.product.quantity }}" data-action="delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
				</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>

                        let arrowUp = document.getElementById('arrow-up');
                        let arrowDown = document.getElementById('arrow-down');
                        let trash = document.getElementById('trash');
                        let user = '{{ user }}';

                        arrowUp.addEventListener('click', Operation);
                        arrowDown.addEventListener('click', Operation);
                        trash.addEventListener('click', Operation);


                        function Operation() {
                            let action = this.dataset.action;
                            let product = this.dataset.product;

                            console.log('action:', action);
                            console.log('product:', product);

                            if (user === 'AnonymousUser') {
                                updateUserOrder(action, product)
                            } else {
                                updateUserOrder(action, product)
                            }

                            if (action === 'delete') {
                                let item = this.dataset.item;
                                dataset.quantity = parseInt(quantity) + 1;
                                order_item = OrderItem.objects.get(id=item);
                                order_item.quantity = quantity;
                            }

                            if (action === 'plus') {

                                let item = this.dataset.item;

                                dataset.quantity = parseInt(quantity) + 1;
                                order_item = OrderItem.objects.get(id=item);
                                order_item.quantity = quantity;

                            }

                            if (action === 'remove') {
                                let item = this.dataset.item;
                                dataset.quantity = parseInt(quantity) + 1;
                                order_item = OrderItem.objects.get(id=item);
                                order_item.quantity = quantity;
                            }
                    }

                    function updateUserOrder(action, product) {
                        console.log('User is authenticated, sending data...');

                        let url = '/update_item/';

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken,
                            },
                            body: JSON.stringify({'action': action, 'product': product})
                        })

                        .then((response) => {
                            return response.json();
                        })

                        .then((data) => {
                            console.log('data:', data);
                            location.reload();
                        });
                    }


                    let csrftoken = getToken('csrftoken')
             function getToken(name) {
                 var cookieValue = null;
                 if (document.cookie && document.cookie !== '') {
                     var cookies = document.cookie.split(';');

                     for (var i = 0; i < cookies.length; i++) {

                         var cookie = cookies[i].trim();

                         if (cookie.substring(0, name.length + 1) === (name + '=')) {

                             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));

                             break;
                         }
                     }
                 }
                 return cookieValue;
             }
             {#let csrftoken = getToken('csrftoken')#}


                     </script>


    <script type="text/javascript">

         const showImageBtn = document.getElementById('show-img-btn');
         const imageOverlay = document.getElementById('img-overlay');
         const imageOverlay1 = document.getElementById('img-overlay-1')
         const LoadDots = document.getElementById('loading-dots')

        showImageBtn.addEventListener('click', function() {
            imageOverlay.style.display = 'block';
            console.log('clicked')
        });

        imageOverlay.addEventListener('click', function() {
            LoadDots.style.display = 'block';
            imageOverlay.style.display = 'none';
        });

        LoadDots.addEventListener('click', function (){
            imageOverlay1.style.display = 'block';
            LoadDots.style.display = 'none';
            imageOverlay.style.display = 'none';
        })

         imageOverlay1.addEventListener('click', function (){
             imageOverlay1.style.display = 'none'
         })

        setTimeout(function() {
            let image = document.getElementById('img-overlay');
            image.setAttribute('src', '{% static 'images/checked.png' %}');
            image.setAttribute('alt', 'New Image');
    }, 5000); // Replace the image after 5 seconds (5000 milliseconds)

         </script>
{% endblock content %}