{% load static %}
{% block css_block %}
    <link rel="stylesheet" href="{% static 'cart.css' %}">
    <link rel="stylesheet" href="{% static 'cart-responsive.css' %}">
{% endblock %}
<script src="https://kit.fontawesome.com/4cf7026c74.js" crossorigin="anonymous"></script>

{% block content %}
	<div class="row">
		<div class="col-lg-12">
			<div class="box-element">

				<a  class="btn btn-outline-dark" href="{% url 'main' %}">&#x2190; Continue Shopping</a>

				<br>
				<br>
				<table class="table">
					<tr>
                        <th><h5>Items: <strong>{{ order.get_cart_items }}</strong></h5></th>
						<th><h5>Total:<strong>${{order.get_cart_total|floatformat:2}}</strong></h5></th>
						<th>
{#							<a  style="float:right; margin:5px;" class="btn btn-success" href="{% url 'checkout' %}">Checkout</a>#}
                            <button style="float:right; margin:5px;" class="btn btn-success">Pay Now</button>
						</th>
					</tr>
				</table>

			</div>

			<br>

			<div class="box-element">
				<div class="cart-row">
					<div style="flex:2"></div>
					<div style="flex:2"><strong>Item</strong></div>
					<div style="flex:1"><strong>Price</strong></div>
					<div style="flex:1"><strong>Quantity</strong></div>
					<div style="flex:1"><strong>Total</strong></div>
                    <div style="flex:1"><strong>Delete</strong></div>

				</div>

                {% for item in items %}
				<div class="cart-row">
                    <div style="flex:2"><img class="row-image" src="{% static 'images/'|add:item.product.name|add:'.jpg' %}" alt="Drink Image" /></div>
                    <div style="flex:2"><p>{{item.product.name}}</p></div>
                    <div style="flex:1"><p>${{item.product.price|floatformat:2}}</p></div>
					<div style="flex:1">
						<p class="quantity">x{{item.quantity}}</p>
						<div class="quantity">

                            <div class="chg-quantity">
                                <button id="arrow-up" data-item="{{item.product.id}}" data-quantity="{{item.quantity}}" data-action="plus"><i class="fa-solid fa-arrow-up"></i></button>
                                <button id="arrow-down" data-item="{{item.product.id}}" data-quantity="{{item.quantity}}" data-action="remove"><i class="fa-solid fa-arrow-down"></i></button>
                            </div>
						</div>
					</div>
                    <div style="flex:1"><p>${{item.get_total|floatformat:2}}</p></div>
                 <div style="flex:1">

{#                     <button id="trash" data-item="{{item.product.id}}" data-quantity="{{item.quantity}}" data-action="delete"><i class="fa-solid fa-trash"></i></button>#}
                        <button id="trash" data-item="{{item.product.id}}" data-quantity="{{item.quantity}}" data-action="delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
				</div>

                     <script>

                        let arrowUp = document.getElementById('arrow-up');
                        let arrowDown = document.getElementById('arrow-down');
                        let trash = document.getElementById('trash');
                        let user = '{{ user }}';

                        arrowUp.addEventListener('click', function(e){
                            console.log('arrow up clicked');
                            console.log(e.target);

                            let item = e.target.dataset.item;
                            let quantity = e.target.dataset.quantity;
                            let action = e.target.dataset.action;
                            console.log('item:', item, 'quantity:', quantity, 'action:', action);
                            if (user == 'AnonymousUser'){
                                console.log('User is not authenticated')
                            }else{
                                updateUserOrder(item, action)
                            }
                        });

                        arrowDown.addEventListener('click', function(e){
                            console.log('arrow down clicked');
                            console.log(e.target);

                            let item = e.target.dataset.item;
                            let quantity = e.target.dataset.quantity;
                            let action = e.target.dataset.action;
                            console.log('item:', item, 'quantity:', quantity, 'action:', action);
                            if (user == 'AnonymousUser'){
                                console.log('User is not authenticated')
                            }else{
                                updateUserOrder(item, action)
                            }
                        });

                        trash.addEventListener('click', function(e){
                            console.log('trash clicked');
                            console.log(e.target);
                            console.log(e.target.dataset);

                            let item = e.target.dataset.item;
                            let quantity = e.target.dataset.quantity;
                            let action = e.target.dataset.action;
                            console.log('item:', item, 'quantity:', quantity, 'action:', action);
                            if (user == 'AnonymousUser'){
                                console.log('User is not authenticated')
                            }else{
                                updateUserOrder(item, action)
                            }
                        });

                        function updateUserOrder(item, action){
                            console.log('User is authenticated, sending data...')

                            let url = '/update_item/'

                            fetch(url, {
                                method:'POST',
                                headers:{
                                    'Content-Type':'application/json',
                                    'X-CSRFToken':csrftoken,
                                },
                                body:JSON.stringify({'item':item, 'action':action})
                            })

                                .then((response) => {
                                    return response.json()
                                })

                                .then((data) => {
                                    console.log('data:', data)
                                    location.reload()
                                })
                        }


                     </script>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock content %}